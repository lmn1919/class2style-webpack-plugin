const fs=require("fs"),path=require("path"),htmlparser2=require("htmlparser2"),babelParser=require("@babel/parser"),glob=require("glob");class Class2styleWebpackPlugin{prefix;ruleConfigPath;output;folderPath;constructor(e){this.prefix=e.prefix||"cts",this.ruleConfigPath=e.ruleConfigPath||"classToStyle.js",this.output=e.output,this.folderPath=e.folderPath}apply(e){e.hooks.done.tap("Class2styleWebpackPlugin",()=>{glob.sync("src/**/*.{html,vue,jsx}").forEach(e=>{var t=path.extname(e);".html"===t||".vue"===t?this.extractClassesFromHTML(e):".jsx"===t&&this.extractClassesFromJSX(e)})}),e.hooks.watchRun.tapAsync("Class2styleWebpackPlugin",(e,t)=>{e=e.modifiedFiles;e&&e.forEach(e=>{var t=path.extname(e);".html"===t||".vue"===t?this.extractClassesFromHTML(e):".jsx"===t&&this.extractClassesFromJSX(e)}),t()})}extractClassesFromHTML(e){e=fs.readFileSync(e,"utf-8");const s=new Set;var t=new htmlparser2.Parser({onopentag(e,t){t.class&&t.class.split(" ").forEach(e=>s.add(e))}}),e=(t.write(e),t.end(),Array.from(s));this.creactCss(e)}extractClassesFromJSX(e){e=fs.readFileSync(e,"utf-8");const a=new Set;!function e(t){"JSXAttribute"===t.type&&"className"===t.name.name&&"StringLiteral"===t.value.type&&t.value.value.split(" ").forEach(e=>a.add(e));for(const s in t)"object"==typeof t[s]&&null!==t[s]&&e(t[s])}(babelParser.parse(e,{sourceType:"module",plugins:["jsx"]}));e=Array.from(a);this.creactCss(e)}async creactCss(e){var t=path.resolve(this.ruleConfigPath);delete require.cache[require.resolve(t)];let o=new(require(t));t=[...new Set(e)];const s=new RegExp("^"+this.prefix);let a=await this.getFileData();e=t.filter(e=>s.test(e)&&a.indexOf(e)<0);let i="";e.forEach(e=>{var t,s=e.split("__"),a=s[1],s=s[2].split("_"),r=(console.log(a,s),o[a](...s));let l=`
.${e}{`;for(t in r)l+=`
    ${t}:${r[t]};`;l+=`
}`,i=""+i+l}),fs.appendFile(this.output,i,e=>{e&&console.log("创建失败："+e),console.log("创建成功！")})}getFileData(){return new Promise((s,e)=>{fs.readFile(this.output,(e,t)=>{e&&s(""),s(t)})})}}module.exports=Class2styleWebpackPlugin;
